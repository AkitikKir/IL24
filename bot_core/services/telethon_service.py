"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª MTProto (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Telethon).
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ –æ–±—ã—á–Ω–æ–º Bot API, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è —Å–º–µ–Ω–∞ —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —á–∞—Ç–∞.
"""

from __future__ import annotations

import logging
from typing import Tuple

from ..config import BotConfig

# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Telethon. –ï—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, —Å–µ—Ä–≤–∏—Å –ø–æ–º–µ—Ç–∏—Ç —Å–µ–±—è –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π.
try:
    from telethon import TelegramClient, functions
except Exception:  # pragma: no cover
    TelegramClient = None
    functions = None


class TelethonService:
    """
    –ö–ª–∞—Å—Å-—Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ Telegram Client API (MTProto).
    –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Bot API, MTProto –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–æ–≤, –∫ –∫–æ—Ç–æ—Ä—ã–º —É –±–æ—Ç–∞ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø 
    –∫–∞–∫ —É –ø–æ–ª–Ω–æ–ø—Ä–∞–≤–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –º–µ–Ω—è—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã.
    """

    def __init__(self, config: BotConfig):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞.
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Telethon –≤ —Å–∏—Å—Ç–µ–º–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å API_ID/API_HASH –≤ –∫–æ–Ω—Ñ–∏–≥–µ.
        –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–æ–∫.
        """
        self.config = config
        self.logger = logging.getLogger(self.__class__.__name__)
        # –§–ª–∞–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞. True —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –∫–ª—é—á–∏ –∑–∞–¥–∞–Ω—ã.
        self.available = bool(TelegramClient and functions and config.telethon.is_configured)

    def set_chat_theme(self, chat_identifier, theme_input) -> Tuple[bool, str]:
        """
        –ú–µ–Ω—è–µ—Ç —Ç–µ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —á–∞—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏.
        –≠–º–æ–¥–∑–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–π –∏–∑ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ–º Telegram (–Ω–∞–ø—Ä., '‚òÄÔ∏è' - –¥–Ω–µ–≤–Ω–∞—è, 'üåô' - –Ω–æ—á–Ω–∞—è).
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            chat_identifier: ID —á–∞—Ç–∞ (int) –∏–ª–∏ –µ–≥–æ @username (str).
            theme_input: –≠–º–æ–¥–∑–∏-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–º—ã.
            
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            –ö–æ—Ä—Ç–µ–∂ (—É—Å–ø–µ—Ö: bool, –æ–ø–∏—Å–∞–Ω–∏–µ_—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: str).
        """
        # –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é/–∞–¥–º–∏–Ω—É
        if not self.available:
            return False, "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Telethon –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞."
            
        try:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç Telethon, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
            # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ –≤–≤–æ–¥–∏—Ç—å –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ.
            client = TelegramClient(
                self.config.telethon.session_name,
                int(self.config.telethon.api_id),
                self.config.telethon.api_hash,
            )
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ Telegram
            client.connect()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–±–æ—á—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.
            # –ï—Å–ª–∏ –Ω–µ—Ç, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SetChatThemeRequest –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.
            if not client.is_user_authorized():
                return False, "Telethon: —Å–µ—Å—Å–∏—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
                
            try:
                # –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º ID –∏–ª–∏ username –≤ InputEntity ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç Telethon –¥–ª—è –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ —á–∞—Ç–æ–≤.
                peer = client.get_input_entity(chat_identifier)
            except Exception as e:
                # –ï—Å–ª–∏ —á–∞—Ç —Å–∫—Ä—ã—Ç –∏–ª–∏ ID –Ω–µ–≤–µ—Ä–Ω—ã–π, –ª–æ–≥–∏—Ä—É–µ–º —ç—Ç–æ –∫–∞–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                self.logger.exception("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —á–∞—Ç –¥–ª—è —Å–º–µ–Ω—ã —Ç–µ–º—ã: %s", e)
                return False, f"–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: {e}"
                
            try:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∑–∞–ø—Ä–æ—Å MTProto –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —á–∞—Ç–∞.
                # emoticon –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–µ–º —ç–º–æ–¥–∑–∏, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ç–µ–º–µ –≤ Telegram.
                client(functions.messages.SetChatThemeRequest(peer=peer, emoticon=str(theme_input)))
                return True, "–¢–µ–º–∞ —á–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞."
            except Exception as e:
                # –û—à–∏–±–∫–∞ –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –µ—Å–ª–∏ —É –±–æ—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ.
                self.logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ SetChatThemeRequest: %s", e)
                return False, f"–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã: {e}"
        except Exception as e:
            # –û–±—â–∏–π –ø–µ—Ä–µ—Ö–≤–∞—Ç —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ –∏–ª–∏ –æ—à–∏–±–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏.
            self.logger.exception("–û–±—â–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ Telethon: %s", e)
            return False, f"–û—à–∏–±–∫–∞ Telethon: {e}"
