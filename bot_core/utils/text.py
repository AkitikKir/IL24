"""
Модуль текстовых утилит для Telegram-бота.
Содержит функции для подготовки текста к отправке, экранирования спецсимволов и форматирования строк.
"""

from __future__ import annotations

import re


def escape_md_v2(text: str) -> str:
    """
    Экранирует специальные символы для режима разметки Telegram MarkdownV2.
    Это критически важно для предотвращения ошибок рендеринга сообщений, 
    когда ИИ возвращает текст с точками, дефисами или скобками.
    """
    if not text:
        return ""
    # Регулярное выражение находит все служебные символы MarkdownV2 и добавляет перед ними обратный слэш
    return re.sub(r"([_\*\[\]\(\)\~\`\>\\\#\+\-\=\|\{\}\.\!])", r"\\\1", text)


def truncate(text: str, n: int = 140) -> str:
    """
    Безопасно обрезает длинную строку до заданного количества символов (по умолчанию 140).
    Используется для генерации превью сообщений или заголовков в интерфейсе.
    Заменяет перенос строки на пробел и добавляет многоточие в конце, если строка была обрезана.
    """
    if not text:
        return ""
    # Удаляем лишние пробелы и заменяем переносы строк для компактности превью
    text = text.replace("\n", " ").strip()
    return (text[: n - 1] + "…") if len(text) > n else text


def make_safe_key(label: str) -> str:
    """
    Преобразует произвольную строку в безопасный технический ключ.
    Используется для формирования callback_data кнопок Telegram.
    Оставляет только латинские буквы и цифры, заменяя всё остальное на подчеркивание.
    """
    # Удаляем спецсимволы, заменяем на '_' и приводим к нижнему регистру
    return re.sub(r"[^0-9a-zA-Z]+", "_", label).strip("_").lower()
